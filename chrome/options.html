<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>kitchen_sink options</title>
		<link rel="stylesheet" type="text/css" href="gui/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="gui/css/kitchen_sink.css">
		<script src="js/jquery-1.6.4.min.js"></script>
		<script src="js/oauth.js"></script>
		<script src="js/sha1.js"></script>
		<script src="js/dropbox.js"></script>
		<script src="js/settings.js"></script>
		<!-- <script type="text/javascript" src="js/chrome_ex_oauthsimple.js"></script>
		<script type="text/javascript" src="js/chrome_ex_oauth.js"></script> -->
		<script src="js/sync.js"></script>
		<script>
			function get_token() {

				var app_key = $("#app_key").val(),
					app_secret = $("#app_secret").val(),
					email = $("#email").val(),
					password = $("#password").val();
				
				settings.set_value("app_key", app_key);
				settings.set_value("app_secret", app_secret);
				settings.set_value("email", email);
				
				dropbox.setup(app_key, app_secret);
				dropbox.authenticate(email, password, function() {
					
					dropbox.getInfo();
					if(dropbox.accessToken() != "" &&  dropbox.accessTokenSecret() != "") {
						//saves the token
						settings.set_value("access_token", dropbox.accessToken());
						settings.set_value("access_token_secret", dropbox.accessTokenSecret());
						switch_form("connected");
					}
				});
			}
			
			function remove_token() {
				settings.set_value("access_token", "");
				settings.set_value("access_token_secret", "");
				switch_form("disconnected");
			}
			
			function sync_now() {
				sync.go();
			}
			
			function switch_form(status) {
				switch(status) {
					case "connected":
						$("#connected_form").show();
						$("#connection_form").hide();
						$("#password").val("");
						break;
					case "disconnected":
						$("#connected_form").hide();
						$("#connection_form").show();
						break;
				}
			}
			
			$(document).ready(function() {
				//check if user aldready set the token
				_access_token = settings.get_value("access_token", "");
				_access_token_secret = settings.get_value("access_token_secret", "");			
				$("#app_key").val(settings.get_value("app_key", ""));
				$("#app_secret").val(settings.get_value("app_secret", ""));
				$("#email").val(settings.get_value("email", ""));
				
				_last_sync = settings.get_value("last_sync_date", "");
				if(_last_sync != "") {
					$("#sync_container").addClass("info");
					$("#last_sync_date").text(_last_sync);
				} else {
					$("#sync_container").addClass("warning");
					$("#last_sync_date").text("no date found");
				}
				
				if(_access_token == "" || _access_token_secret == "" ) {
					switch_form("disconnected");	
				} else {
					switch_form("connected");
					dropbox.setup(app_key, app_secret);
					dropbox.set_accessTokenSecret(_access_token_secret);
					dropbox.set_accessToken(_access_token);
				}
			});
		</script>
	</head>
	<body>
		<div class="container">
			<div class="content">
				<div class="page-header">
					<h1>kitchen_sink <small>options</small></h1>
				</div>
				<div class="row">
					<div class="span14">
						<h3>Dropbox Settings</h3>
						<form id="connection_form">
							<fieldset>
								<div class="clearfix">
									<label for="app_key">App key</label>
									<div class="input">
										<input class="xlarge" id="app_key" name="app_key" size="30" type="text">
									</div>
								</div>
								<div class="clearfix">
									<label for="app_secret">App secret</label>
									<div class="input">
										<input class="xlarge" id="app_secret" name="app_secret" size="30" type="text">
									</div>
								</div>
								<div class="clearfix">
									<label for="email">Email</label>
									<div class="input">
										<input class="xlarge" id="email" name="email" size="30" type="text">
									</div>
								</div>
								<div class="clearfix">
									<label for="password">Password</label>
									<div class="input">
										<input class="xlarge" id="password" name="password" size="30" type="password">
										(not saved)
									</div>
								</div>
							</fieldset>
							<div class="actions">
								<input type="button" onclick="get_token()" class="btn primary" value="Get token">
							</div>
						</form>
						<form id="connected_form">
							<div class="alert-message block-message success">
								<p>Your account is connected with Dropbox.</p>
								<p>&nbsp;</p>
								<div class="alert-actions">
									<a class="btn small" href="#" onclick="remove_token();">Remove connection</a>
								</div>
							</div>
							<h3>Sync</h3>						
							<div id="sync_container" class="alert-message block-message">
								<p>Last sync: <span id="last_sync_date"><span></p>
								<p>&nbsp;</p>
								<div class="alert-actions">
									<a href="#" onclick="sync_now();" class="btn small">Sync now</a>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
			<footer>
				<p>Code by <a target="_blank" href="http://www.gvnn.it">Gvnn</a> - kitchen_sink on <a target="_blank" href="https://github.com/gvnn/kitchen_sink">GitHub</a></p>
			</footer>
		</div>
	</body>
</html>
